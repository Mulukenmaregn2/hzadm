<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Meta Tags -->
	<meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hyranzi School System</title>
    <meta name="description" content="A modern school with modern system"/>
    
	<!-- Favicon -->
    <link rel="shortcut icon" href="assets/img/hz_logo_sm.png">
    <link rel="icon" href="assets/img/hz_logo_sm.png" type="image/x-icon">
	
	<!-- Daterangepicker CSS -->
    <link href="assets/css/daterangepicker.css" rel="stylesheet" type="text/css" />

	<!-- Data Table CSS -->
    <link href="assets/css/dataTables.bootstrap5.min.css" rel="stylesheet" type="text/css" />
    <link href="assets/css/responsive.bootstrap5.min.css" rel="stylesheet" type="text/css" />

	<!-- CSS -->
    <link href="assets/css/style.css" rel="stylesheet" type="text/css">
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
		<style>
			.nav {
  white-space: nowrap;      /* Prevent wrapping */
  overflow-x: auto;         /* Enable horizontal scroll */
  -webkit-overflow-scrolling: touch; /* Smooth scrolling on mobile */
}
.nav::-webkit-scrollbar {
  display: none; /* Hide scrollbar for a cleaner look */
}
		</style>
		
    <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-database.js"></script>
</head>
<body>
	<!-- Wrapper -->
	<div class="hk-wrapper" data-layout="vertical" data-layout-style="default" data-menu="light" data-footer="simple">
		<!-- Top Navbar -->
		<nav class="hk-navbar navbar navbar-expand-xl navbar-light fixed-top">
			<div class="container-fluid">
			<!-- Start Nav -->
			<div class="nav-start-wrap">
				<button class="btn btn-icon btn-rounded btn-flush-dark flush-soft-hover navbar-toggle d-xl-none"><span class="icon"><span class="feather-icon"><i data-feather="align-left"></i></span></span></button>
					
				<!-- Search -->
				<form class="dropdown navbar-search">
					<div class="dropdown-toggle no-caret" data-bs-toggle="dropdown" data-dropdown-animation data-bs-auto-close="outside">
						<a href="#" class="btn btn-icon btn-rounded btn-flush-dark flush-soft-hover  d-xl-none"><span class="icon"><span class="feather-icon"><i data-feather="search"></i></span></span></a>
						<div class="input-group d-xl-flex d-none">
							<span class="input-affix-wrapper input-search affix-border">
								<input type="text" class="form-control  bg-transparent"  data-navbar-search-close="false" placeholder="Search..." aria-label="Search">
								
							</span>
						</div>
					</div>
				</form>
				<!-- /Search -->
			</div>
			<!-- /Start Nav -->
			
			<!-- End Nav -->
			<div class="nav-end-wrap">
			</div>
			<!-- /End Nav -->
			</div>									
		</nav>
		<!-- /Top Navbar -->

    <!-- Vertical Nav -->
    <div class="hk-menu">
			<!-- Brand -->
			<div class="menu-header">
				<span>
					<a class="navbar-brand d-flex align-items-center" href="index.html">
						<img class="brand-img img-fluid" style="width: 45px; height: 45px; margin-right: 10px;" src="assets/img/hz_logo_md.png" alt="brand" />
						<div class="d-inline-block nav-link-text">
							<b class="mb-0" style="color: #9b5e02; margin-bottom: 0px;">Hyranzi</b>
							<div class="fs-7 text-muted mt-0">School System</div>
						</div>
					</a>
					<button class="btn btn-icon btn-rounded btn-flush-dark flush-soft-hover navbar-toggle">
						<span class="icon">
							<span class="svg-icon fs-5">
								<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-arrow-bar-to-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
									<path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
									<line x1="10" y1="12" x2="20" y2="12"></line>
									<line x1="10" y1="12" x2="14" y2="16"></line>
									<line x1="10" y1="12" x2="14" y2="8"></line>
									<line x1="4" y1="4" x2="4" y2="20"></line>
								</svg>
							</span>
						</span>
					</button>
				</span>
			</div>
			<!-- /Brand -->

			<!-- Main Menu -->
			<div data-simplebar class="nicescroll-bar">
			</div>
			<!-- /Main Menu -->
		</div>
        <div id="hk_menu_backdrop" class="hk-menu-backdrop"></div>
        <!-- /Vertical Nav -->


		<!-- Main Content -->
		<div class="hk-pg-wrapper">
			<div class="container-xxl">
				<!-- Page Header -->
				<div class="hk-pg-header pg-header-wth-tab pt-7">
					<div class="d-flex">
						<div class="d-flex flex-wrap justify-content-between flex-1">
							<div class="mb-lg-0 mb-2 me-8">
								<h1 class="pg-title"><i class="ri-contacts-fill me-1"></i>Teachers List</h1>
								<p>Get all teachers data here..</p>
								<span class="text-primary fs-7 fw-medium tbinfos"></span>
							</div>
						</div>
					</div>
				</div>

				<!-- /Page Header -->

				
				<!-- Page Body -->
				<div class="row hk-pg-body p-0">
				  <!-- /Page Body -->	
					 <div class="col-xl-12">
						<div class="card">
							<div class="card-body p-0">
								<div class="table-responsive">
									<table id="studentsTable" class="table table-striped table-bordered w-100">
										<thead>
											<tr>
												<th>#</th>
												<th>Teacher ID</th>
												<th>Teacher Name and Photo</th>
												<th>Phone & Email</th>
												<th>Field & Department</th>
												<th>Actions</th>
											</tr>
										</thead>
										<tbody>
											<tr>
												<td>1</td>
												<td>TEA001</td>
												<td>
													<div class="d-flex align-items-center">
														<div class="avatar avatar-rounded avatar-sm me-2">
															<img src="assets/img/no-avatar_male.jpg" alt="student" class="avatar-img">
														</div>
														<div>
															<span class="fw-medium">John Doe</span>
														</div>
													</div>
												</td>
												<td>
														<div class="d-flex flex-column">
														<span class="text-muted"><i class="ri ri-phone-line"></i> +251 912 345 678</span>
														<span class="text-muted"><i class="ri ri-mail-open-line"></i> example@gmail.com</span>
													</div>
												</td>
												<td>
														<div class="d-flex flex-column">
														<span class="text-muted"><i class="ri ri-building-2-line"></i> Field: Math</span>
														<span class="text-muted"><i class="ri ri-map-pin-2-line"></i> Dept: Science</span>
													</div>
												</td>
												<td>
													<div class="d-flex">
														<a href="teacher_profile.html" class="btn btn-icon btn-rounded btn-outline-primary me-1" title="View Profile"><span class="icon"><span class="feather-icon"><i data-feather="eye"></i></span></span></a>
														<a href="teacher_edit.html" class="btn btn-icon btn-rounded btn-outline-warning me-1" title="Edit Teacher"><span class="icon"><span class="feather-icon"><i data-feather="edit"></i></span></span></a>
														<a href="#" class="btn btn-icon btn-rounded btn-outline-danger" title="Delete Teacher"><span class="icon"><span class="feather-icon"><i data-feather="trash-2"></i></span></span></a>
													</div>
												</td>
											</tr>
										</tbody>
									</table>
								</div>
							</div>
						</div>
					</div>
				</div>	
			</div>
			
			<!-- Page Footer -->
			<div class="hk-footer">
				<footer class="container-xxl footer">
					<div class="row">
						<div class="col-xl-8">
							<p class="footer-text"><span class="copy-text">Hayranzi Â© 2025 All rights reserved.</span> <a href="#" class="" target="_blank">Privacy Policy</a><span class="footer-link-sep">|</span><a href="#" class="" target="_blank">T&C</a><span class="footer-link-sep">|</span><a href="#" class="" target="_blank">System Status</a></p>
						</div>
						<!--div class="col-xl-4">
							<a href="#" class="footer-extr-link link-default"><span class="feather-icon"><i data-feather="external-link"></i></span><u>Send feedback to our help forum</u></a>
						</div-->
					</div>
				</footer>
      </div>
      <!-- / Page Footer -->
		</div>
		
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
      <div id="toastMessage" class="toast align-items-center text-bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body">
            Please get the verification code first / click "send" to get the code
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      </div>
    </div>
		<!-- /Main Content -->
	</div>
    <!-- /Wrapper -->
    <script src="assets/js/sidebar.js"></script>
		<script type="module" src="assets/js/side.state.js"></script>
		<script>
			gowindow('Teachers List');
		</script>

	<!-- jQuery -->
    <script src="assets/js/jquery.min.js"></script>

    <!-- Bootstrap Core JS -->
   	<script src="assets/js/bootstrap.bundle.min.js"></script>

    <!-- FeatherIcons JS -->
    <script src="assets/js/feather.min.js"></script>

    <!-- Fancy Dropdown JS -->
    <script src="assets/js/dropdown-bootstrap-extended.js"></script>

	<!-- Simplebar JS -->
	<script src="assets/js/simplebar.min.js"></script>
	
	<!-- Data Table JS -->
    <script src="assets/js/dataTables.min.js"></script>
    <script src="assets/js/dataTables.bootstrap5.min.js"></script>
	<script src="assets/js/dataTables.select.min.js"></script>

	<!-- Daterangepicker JS -->
    <script src="assets/js/moment.min.js"></script>
	<script src="assets/js/daterangepicker.js"></script>
	<script src="assets/js/daterangepicker-data.js"></script>

	<!-- Amcharts Maps JS -->
	<script src="lib/5/map.js"></script> 
	<script src="lib/5/geodata/worldLow.js"></script>
	<script src="lib/5/themes/Animated.js"></script>

	<!-- Apex JS -->
	<script src="assets/js/apexcharts.min.js"></script>

	<!-- Init JS -->
	<script src="assets/js/init.js"></script>
	<script src="assets/js/chips-init.js"></script>
			<script type="module">
				// Simple loader: fetch all teachers and render them in a flat table.
				const RTDB_BASE = 'https://hyranzi-default-rtdb.firebaseio.com';
				async function loadTeachers() {
					document.querySelector('.tbinfos').innerText = "Loading teachers...";
					document.querySelector('tbody').innerHTML = `<tr><td colspan="6" class="text-center text-primary">Loading data...</td></tr>`;
					try {
						const listUrl = `${RTDB_BASE}/${encodeURIComponent('Teachers List')}.json`;
						const res = await fetch(listUrl);
						if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
						const data = await res.json();
						if (!data || Object.keys(data).length === 0) {
							document.querySelector('tbody').innerHTML = `<tr><td colspan="6" class="text-center text-danger">No teachers found.</td></tr>`;
							document.querySelector('.tbinfos').innerText = "No teachers found";
							return;
						}

						// flatten possible year-grouped data into a single array of teacher objects
						let teachers = [];
						// iterate top-level entries so we can keep DB keys
						Object.entries(data).forEach(([topKey, topVal]) => {
							if (topVal && (topVal.teid || topVal.fnm || topVal.pno)) {
								// flat entry at Teachers List/{topKey}
								teachers.push({ ...topVal, _key: topKey });
							} else if (topVal && typeof topVal === 'object') {
								// year-grouped: each child key under topKey is a teacher object
								Object.entries(topVal).forEach(([subKey, child]) => {
									if (child) teachers.push({ ...child, _key: subKey, _parent: topKey });
								});
							}
						});

						document.querySelector('.tbinfos').innerText = "Total Teachers: "+teachers.length;
						document.querySelector('tbody').innerHTML = '';
						teachers.forEach((y, index) => {
							const dbKey = y._key || y.uid || '';
							document.querySelector('tbody').innerHTML += `
							<tr data-dbkey="${dbKey}">
												<td>${index + 1}</td>
								<td>${y.teid || y.uid || 'N/A'}</td>
								<td>
									<div class="d-flex align-items-center">
										<div class="avatar avatar-rounded avatar-sm me-2">
											<img src="${y.img || 'assets/img/no-avatar_male.jpg'}" alt="teacher" class="avatar-img">
										</div>
										<div>
											<span class="fw-medium">${y.fnm? (y.fnm).split(":").join(' '):'N/A'}</span>
										</div>
										</div>
									</td>
								<td>
									<div class="d-flex flex-column">
										<span class="text-muted"><i class="ri ri-phone-line"></i>${y.pno||'N/A'}</span>
										<span class="text-muted"><i class="ri ri-mail-open-line"></i>${y.eml||'N/A'}</span>
									</div>
								</td>
								<td>
									<div class="d-flex flex-column">
										<div style="width:150px;" class="text-muted d-block"><i class="ri ri-building-2-line"></i> Field-${y.fos||'Not Specified'}</div>
										<div class="text-muted"><i class="ri ri-map-pin-2-line"></i> Dept-${y.wdu||'Not Specified'}</div>
									</div>
								</td>
								<td>
									<div class="d-flex">
													<a href="teacher_profile.html" class="btn btn-icon btn-rounded btn-outline-primary me-1" title="View Profile"><span class="icon"><span class="feather-icon"><i data-feather="eye"></i></span></span></a>
													<a href="teacher_edit.html" class="btn btn-icon btn-rounded btn-outline-warning me-1" title="Edit Teacher"><span class="icon"><span class="feather-icon"><i data-feather="edit"></i></span></span></a>
													<button data-key="${dbKey}" data-parent="${y._parent||''}" class="btn btn-icon btn-rounded btn-outline-danger btn-delete-teacher" title="Delete Teacher"><span class="icon"><span class="feather-icon"><i data-feather="trash-2"></i></span></span></button>
									</div>
								</td>
							</tr>`;
						});
						feather.replace();

						// (Re)initialize DataTable so DOM changes are reflected
						try {
							if (window.jQuery && $.fn && $.fn.DataTable) {
								if ($.fn.DataTable.isDataTable('#studentsTable')) {
									$('#studentsTable').DataTable().clear().destroy();
								}
								$('#studentsTable').DataTable({
									responsive: true,
									columnDefs: [{ orderable: false, targets: -1 }]
								});
							}
						} catch (dtErr) { console.warn('DataTable init error', dtErr); }

						// wire delete buttons (pass parent if present)
							document.querySelectorAll('.btn-delete-teacher').forEach(btn => {
								btn.addEventListener('click', async function () {
									const key = this.getAttribute('data-key');
									const parent = this.getAttribute('data-parent') || '';
									if (!key) { showToast('Unable to determine teacher key for delete'); return; }
									try {
										await deleteTeacher(key, parent);
										showToast('Teacher deleted');
										await loadTeachers();
									} catch (err) {
										console.error(err);
										showToast('Delete failed');
									}
								});
							});

						// delete helper: remove Teachers Detail/{key} and any Teachers List entries that reference this teacher (flat or year-grouped)
						async function deleteTeacher(key, parent) {
							if (!confirm('Delete this teacher? This will remove both Teachers Detail and Teachers List entries.')) return;
							// Build a single multi-path update where each path to delete is set to null
							const updates = {};
							// Delete detail node
							updates[`Teachers Detail/${key}`] = null;

							// If parent provided (year-group), delete that specific child path as well
							if (parent) {
								updates[`Teachers List/${parent}/${key}`] = null;
							}

							// Find any other list entries that reference this key. We'll fetch Teachers List and search for entries with uid/key matching.
							const listUrl = `${RTDB_BASE}/${encodeURIComponent('Teachers List')}.json`;
							const res = await fetch(listUrl);
							if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
							const listData = await res.json();
							if (listData) {
								Object.entries(listData).forEach(([k, v]) => {
									if (!v) return;
									if (v && (v.teid || v.fnm || v.pno)) {
										// flat entry
										if (k === key || v.uid === key) updates[`Teachers List/${k}`] = null;
									} else if (v && typeof v === 'object') {
										// year-grouped: iterate children
										Object.entries(v).forEach(([subk, subv]) => {
											if (!subv) return;
											if (subk === key || subv.uid === key) updates[`Teachers List/${k}/${subk}`] = null;
										});
									}
								});
							}

							// send the multi-path PATCH
							const patchUrl = `${RTDB_BASE}/.json`;
							const resp = await fetch(patchUrl, {
								method: 'PATCH',
								headers: { 'Content-Type': 'application/json' },
								body: JSON.stringify(updates)
							});
							if (!resp.ok) throw new Error(`Delete failed: HTTP ${resp.status} ${resp.statusText}`);
						}
					} catch (err) {
						document.querySelector('tbody').innerHTML = `<tr><td colspan="6" class="text-center text-danger">Error loading teachers.</td></tr>`;
						document.querySelector('.tbinfos').innerText = "Error loading teachers";
						console.error(err);
					}
				}

				await loadTeachers();
			</script>
</body>
</html>